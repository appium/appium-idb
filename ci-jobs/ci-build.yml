# https://docs.microsoft.com/azure/devops/pipelines/languages/android
parameters:
  name: ios-e2e-test
  iosVersion: 15.2
  xcodeVersion: 13.2
  deviceName: 'iPhone 11 Pro Max'
  vmImage: 'macOS-11'

jobs:
  - job: ${{ parameters.name }}
    variables:
      PLATFORM_VERSION: ${{ parameters.iosVersion }}
      DEVICE_NAME: ${{ parameters.deviceName }}
      MOCHA_FILE: '${{ parameters.name }}-tests.xml'
      CI: true
    pool:
      vmImage: ${{ parameters.vmImage }}
    steps:
    - checkout: self
    - bash: |
        echo "Mocha output file: $MOCHA_FILE"
        echo "Platform Version: $PLATFORM_VERSION"
        echo "Device Name: $DEVICE_NAME"
      displayName: Print Environment Variables
    - script: ls /Applications/
      displayName: List Installed Applications
    - script: sudo xcode-select -s /Applications/Xcode_${{ parameters.xcodeVersion }}.app/Contents/Developer
      displayName: Xcode Select ${{ parameters.xcodeVersion }}
    - script: xcodebuild -version
      displayName: Log Xcode Version
    - script: xcrun simctl list
      displayName: List Installed Simulators
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.7'
    - bash: |
        brew tap facebook/fb
        brew install idb-companion
        /usr/local/bin/pip3 install --user fb-idb
      displayName: Install IDB
    - task: NodeTool@0
      inputs:
        versionSpec: 14.x
    - script: npm install
      displayName: Install node dependencies
    - script: export PATH="${PATH}:$(python3 -c 'import site; print(site.USER_BASE)')/bin" && npm run e2e-test
      displayName: Run functional tests
    - task: PublishTestResults@2
      condition: always()
      inputs:
        testResultsFiles: $(MOCHA_FILE)
